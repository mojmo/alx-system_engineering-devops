global
    log     /dev/log local0 notice
    maxconn 2000
    user    haproxy
    group   haproxy
    ssl-dh-param-file /etc/haproxy/dhparams.pem

defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        retries 3
        option  redispatch
        timeout connect  5000
        timeout client  10000
        timeout server  10000

frontend www-http
    bind            *:80
    reqadd          X-Forwarded-Proto:\ http
    default_backend www-backend

frontend            www-https
    bind            *:443 ssl crt /etc/haproxy/certs/www.mugtaba.tech.pem
    reqadd          X-Forwarded-Proto:\ https
    acl             letsencrypt-acl path_beg /.well-known/acme-challenge/
    use_backend     letsencrypt-backend if letsencrypt-acl
    default_backend www-backend

backend www-backend
    balance  roundrobin
    redirect scheme https if !{ ssl_fc }
    server   508797-web-01 3.83.253.65:80 check
    server   508797-web-02 3.84.239.237:80 check

backend letsencrypt-backend
    server letsencrypt 127.0.0.1:5000
